<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deploying Gogs to a DigitalOcean Kubernetes cluster | Matias Pan's blog</title>
<meta name=keywords content="kubernetes"><meta name=description content="In this post I will show step by step how to create a Kubernetes cluster on DigitalOcean and then deploy Gogs to the cluster using a set of tools that automate all this.
Creating the Cluster Choosing the Cloud Provider I chose DigitalOcean as the cloud provider since it&rsquo;s the cheapest I could find and it has worked really well for me in the past, plus I was already familiar with a few of their products."><meta name=author content="matipan"><link rel=canonical href=https://blog.matiaspan.dev/posts/deploying-gogs-to-a-custom-kubernetes-cluster/><link crossorigin=anonymous href=/assets/css/stylesheet.a801c217e3c96db9c9df36cb1d2216a9bc5d9fa77b72e2afcdf47fb847f8f015.css integrity="sha256-qAHCF+PJbbnJ3zbLHSIWqbxdn6d7cuKvzfR/uEf48BU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.matiaspan.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://blog.matiaspan.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://blog.matiaspan.dev/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://blog.matiaspan.dev/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://blog.matiaspan.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Deploying Gogs to a DigitalOcean Kubernetes cluster"><meta property="og:description" content="In this post I will show step by step how to create a Kubernetes cluster on DigitalOcean and then deploy Gogs to the cluster using a set of tools that automate all this.
Creating the Cluster Choosing the Cloud Provider I chose DigitalOcean as the cloud provider since it&rsquo;s the cheapest I could find and it has worked really well for me in the past, plus I was already familiar with a few of their products."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.matiaspan.dev/posts/deploying-gogs-to-a-custom-kubernetes-cluster/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-09-16T00:00:00-03:00"><meta property="article:modified_time" content="2018-09-16T00:00:00-03:00"><meta property="og:site_name" content="Matias Pan's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploying Gogs to a DigitalOcean Kubernetes cluster"><meta name=twitter:description content="In this post I will show step by step how to create a Kubernetes cluster on DigitalOcean and then deploy Gogs to the cluster using a set of tools that automate all this.
Creating the Cluster Choosing the Cloud Provider I chose DigitalOcean as the cloud provider since it&rsquo;s the cheapest I could find and it has worked really well for me in the past, plus I was already familiar with a few of their products."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.matiaspan.dev/posts/"},{"@type":"ListItem","position":2,"name":"Deploying Gogs to a DigitalOcean Kubernetes cluster","item":"https://blog.matiaspan.dev/posts/deploying-gogs-to-a-custom-kubernetes-cluster/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deploying Gogs to a DigitalOcean Kubernetes cluster","name":"Deploying Gogs to a DigitalOcean Kubernetes cluster","description":"In this post I will show step by step how to create a Kubernetes cluster on DigitalOcean and then deploy Gogs to the cluster using a set of tools that automate all this.\nCreating the Cluster Choosing the Cloud Provider I chose DigitalOcean as the cloud provider since it\u0026rsquo;s the cheapest I could find and it has worked really well for me in the past, plus I was already familiar with a few of their products.","keywords":["kubernetes"],"articleBody":"In this post I will show step by step how to create a Kubernetes cluster on DigitalOcean and then deploy Gogs to the cluster using a set of tools that automate all this.\nCreating the Cluster Choosing the Cloud Provider I chose DigitalOcean as the cloud provider since it’s the cheapest I could find and it has worked really well for me in the past, plus I was already familiar with a few of their products. You could follow this tutorial using a different provider but there will be a few differences when configuring the persistent volumes for gogs.\nGo ahead and create an account there if you don’t already have one. Note that they will request you to register a valid credit or debit card but they won’t charge you anything as long as you destroy the cluster once you are done with this post but if you leave it running it won’t cost more than 30 USD per month.\nStackPointCloud StackPointCloud is a web application that allows us to create a Kubernetes cluster on many different cloud provider with no more than a few clicks. The cluster they deploy also comes with a few nice things already configured such as Helm and the Kubernetes Dashboard.\nIf you really want to learn what it’s like to setup a cluster on your own you could use Ansible to automate the installation of kubernetes on the machines and then configure helm, the dashboard and coreDNS but it will take much more than just a few clicks. If you feel like it you can follow this tutorial, it took a while for me to get it working since I was not familiar with any of the tools mentioned there but it was really fun.\nAfter you created an account on StackPointCloud click on the Create cluster link and select DigitalOcean as provider. After that a window looking like this will be opened:\nOn the left you see all the information of cluster that it’s being created. By default StackPoint recommends 1 master and 2 workers, all using coreOS with 2GB of RAM and 50GB of storage in the NYC3 region. If you want you could edit the cluster details by clicking edit and modifying the fields there:\nI’m going to leave it as is since it is a good and simple configuration for this use case.\nYou need to create a DigitalOcean API token and provide it to StackPoint so that they can provision the droplets and configure everything. Head over to DigitalOcean’s cloud console and create a new personal access token by clicking on the Generate New Token link:\nOnce you generated your token copy it over to the StackPoint configuration. Next you will generate an SSH key(or use an existing one) on your machine and add it to StackPoint.\nNow you are ready to hit create and wait since it takes a while for all droplets to be provisioned and configured. Once you are done you should see the info of the cluster and it should look somewhat like this:\nThats it!! You just created a 3 node kubernetes cluster, it really was no more than a few clicks!\nWe are almost done with the cluster setup. Now you need to configure your local kubectl installation to point to the recently created cluster(if have not installed kubectl yet follow this tutorial). In the StackPoint cluster page previously showed you’ll see a link on the left that says kubeconf, download that file and copy its contents to ~/.kube/config. To check if it was properly configured run kubectl cluster-info and the output should look similar to this:\nKubernetes master is running at https://: Heapster is running at https://:/api/v1/namespaces/kube-system/services/heapster/proxy KubeDNS is running at https://:/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'. Installing Gogs Gogs is a lightweight git server that can deployed very easily since it does not have many dependencies and features like Gitlab CE.\nTo install Gogs on our cluster we are going to be using Helm so if you don’t already have it installed and configured follow this tutorial. After that you need to add the incubator repo since that is where the gogs chart lives:\nhelm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com/ Since we are going to change a lot of the default values that come with the gogs chart you need to clone the charts repository:\ngit clone https://github.com/helm/charts.git Inside the charts repo you will have the folder incubator that holds the gogs chart. In there you’ll find the values.yml file that is used when installing gogs, this file would be good for local installations but since we are installing this on a cloud provider we are going to have to change a few things.\nThis is the resulting values.yml, below I’ll explain what I have changed and which properties you need to configure:\nserviceType: LoadBalancer replicaCount: 2 image: repository: gogs/gogs tag: 0.11.29 pullPolicy: IfNotPresent service: httpPort: 80 sshPort: 22 sshDomain: CHANGEME gogs: appName: 'Some name' runMode: 'prod' forcePrivate: true disableHttpGit: false repositoryUploadEnabled: true repositoryUploadAllowedTypes: repositoryUploadMaxFileSize: 50 repositoryUploadMaxFiles: 5 serviceEnableCaptcha: false serviceRegisterEmailConfirm: false serviceDisableRegistration: false serviceRequireSignInView: true serviceEnableNotifyMail: false cacheAdapter: memory cacheInterval: 60 cacheHost: serverDomain: CHANGEME serverRootUrl: http://CHANGEME serverLandingPage: home databaseType: postgres databaseHost: databaseUser: databasePassword: databaseName: webhookQueueLength: 1000 webhookDeliverTimeout: 5 webhookSkipTlsVerify: true webhookPagingNum: 10 logMode: console logLevel: Trace otherShowFooterBranding: false otherShowFooterVersion: true otherShowFooterTemplateLoadTime: true securitySecretKey: \"changeme\" uiExplorePagingNum: 20 uiIssuePagingNum: 10 uiFeedMaxCommitNum: 5 ingress: enabled: false persistence: enabled: true storageClass: \"do-block-storage\" accessMode: ReadWriteOnce size: 20Gi postgresql: install: true postgresUser: gogs postgresPassword: gogs postgresDatabase: gogs persistence: enabled: true storageClass: \"do-block-storage\" size: 5Gi Ok, that’s a big file and lots of configs. I’m not going to go over each value and explain what it means(I don’t even know), but lucky for you the default values.yml has a lot of comments that explain quite well each config.\nThis are the fields that were changed and the ones you need to setup:\nserviceType: previously it was setup as NodePort which is fine for local setups but since we are running in the cloud we need to specify it as a LoadBalancer. replicaCount: it was changed from 1 to 2 so that I always have two instances running. sshDomain: this will be the domain used when gogs renders the SSH urls for clones, if you plan to setup a domain name on top of this you can use that, if not then set whatever you’d like since this doesn’t affect the functionality of gogs it’s just that the UI will be lying to you saying to clone it as git clone git@localhost:user/repo.git or something like that. forcePrivate: set to true so that by default the UI checks the private checkmark when creating a new repository. repositoryUploadMaxFileSize: set to 50(in MB) so that the maximum file size that can be uploaded is of 50MB. serverDomain: the domain of gogs, same as with SSH. Use your domain name. serverRotUrl: basicaly http or https plus the serverDomain. storageClass: this is under the persistence section, you need to specify the storageClass used for persistent volumes, if you were using DigitalOcean then leave it with do-block-storage. Otherwise check your storage class with kubectl get storageClass and use that value. storageClass: this is the one found under the postgresql section and you should put the same value as before. Now that all the configurations are in place we can use helm to install gogs on our cluster. Inside the charts repo you recently cloned execute the following command:\nhelm install --name gogs -f incubator/gogs/values.yaml incubator/gogs This magic command will install and configure all the pods, services, deployments and load balancers needed to run 2 replicas of gogs.\nIt will take a while before gogs is able to be used, you can check the status of the installation with the following command:\nhelm status gogs In the output of the helm install command you will find a few commands that will also be useful for checking the status of the installation, this one will allow you to know when the IP of the LoadBalancer is ready:\nkubectl get svc --namespace {{ .Release.Namespace }} -w {{ template \"gogs.fullname\" . }} After it is ready execute the following three commands to find out where exactly is gogs living:\nexport NODE_PORT=$(kubectl get --namespace {{ .Release.Namespace }} -o jsonpath=\"{.spec.ports[0].nodePort}\" services {{ template \"gogs.fullname\" . }}) export NODE_IP=$(kubectl get nodes --namespace {{ .Release.Namespace }} -o jsonpath=\"{.items[0].status.addresses[0].address}\") echo http://$NODE_IP:$NODE_PORT/ The output of the last command will show you the URL for accessing gogs. Head over to that URL and register a user, this user will be the admin of the application.\nConclusion Congrats!!! You just created your own scalable git server running on a kubernetes cluster, it’s amazing how the tools we have available have reduced the complexity of things such as automated deployment, scalability and availability.\n","wordCount":"1468","inLanguage":"en","datePublished":"2018-09-16T00:00:00-03:00","dateModified":"2018-09-16T00:00:00-03:00","author":{"@type":"Person","name":"matipan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.matiaspan.dev/posts/deploying-gogs-to-a-custom-kubernetes-cluster/"},"publisher":{"@type":"Organization","name":"Matias Pan's blog","logo":{"@type":"ImageObject","url":"https://blog.matiaspan.dev/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.matiaspan.dev/ accesskey=h title="Home (Alt + H)"><img src=https://blog.matiaspan.dev/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.matiaspan.dev/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://blog.matiaspan.dev/search/ title=Search><span>Search</span></a></li><li><a href=https://blog.matiaspan.dev/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://blog.matiaspan.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Deploying Gogs to a DigitalOcean Kubernetes cluster</h1><div class=post-meta><span title='2018-09-16 00:00:00 -0300 -03'>September 16, 2018</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;matipan&nbsp;|&nbsp;<a href=https://github.com/matipan/matipan.github.io/tree/main/content/posts/deploying-gogs-to-a-custom-kubernetes-cluster.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#creating-the-cluster>Creating the Cluster</a></li><li><a href=#installing-gogs>Installing Gogs</a></li><li><a href=#conclusion>Conclusion</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>In this post I will show step by step how to create a <a href=https://kubernetes.io>Kubernetes</a> cluster on <a href=https://digitalocean.com>DigitalOcean</a> and then deploy <a href=https://gogs.io>Gogs</a> to the cluster using a set of tools that automate all this.</p><h3 id=creating-the-cluster>Creating the Cluster<a hidden class=anchor aria-hidden=true href=#creating-the-cluster>#</a></h3><h5 id=choosing-the-cloud-provider>Choosing the Cloud Provider<a hidden class=anchor aria-hidden=true href=#choosing-the-cloud-provider>#</a></h5><p>I chose <a href=https://digitalocean.com>DigitalOcean</a> as the cloud provider since it&rsquo;s the cheapest I could find and it has worked really well for me in the past, plus I was already familiar with a few of their products. You could follow this tutorial using a different provider but there will be a few differences when configuring the persistent volumes for gogs.<br>Go ahead and create an account there if you don&rsquo;t already have one. Note that they will request you to register a valid credit or debit card but they won&rsquo;t charge you anything as long as you destroy the cluster once you are done with this post but if you leave it running it won&rsquo;t cost more than 30 USD per month.</p><h5 id=stackpointcloud>StackPointCloud<a hidden class=anchor aria-hidden=true href=#stackpointcloud>#</a></h5><p><a href=https://stackpoint.io>StackPointCloud</a> is a web application that allows us to create a Kubernetes cluster on many different cloud provider with no more than a few clicks. The cluster they deploy also comes with a few nice things already configured such as <a href=https://helm.sh>Helm</a> and the <a href=https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/>Kubernetes Dashboard</a>.<br>If you really want to learn what it&rsquo;s like to setup a cluster on your own you could use <a href=https://www.ansible.com/>Ansible</a> to automate the installation of kubernetes on the machines and then configure helm, the dashboard and coreDNS but it will take much more than just a few clicks. If you feel like it you can follow <a href=https://www.digitalocean.com/community/tutorials/how-to-create-a-kubernetes-1-10-cluster-using-kubeadm-on-ubuntu-16-04>this tutorial</a>, it took a while for me to get it working since I was not familiar with any of the tools mentioned there but it was really fun.</p><p>After you created an account on <a href=https://stackpoint.io>StackPointCloud</a> click on the <code>Create cluster</code> link and select DigitalOcean as provider. After that a window looking like this will be opened:</p><p><img loading=lazy src=/images/stackpoint-create.png alt=stackpoint-create></p><p>On the left you see all the information of cluster that it&rsquo;s being created. By default StackPoint recommends 1 master and 2 workers, all using <a href=https://coreos.com/>coreOS</a> with 2GB of RAM and 50GB of storage in the NYC3 region. If you want you could edit the cluster details by clicking edit and modifying the fields there:</p><p><img loading=lazy src=/images/stackpoint-cluster-info.png alt=stackpoint-cluster-info></p><p>I&rsquo;m going to leave it as is since it is a good and simple configuration for this use case.<br>You need to create a DigitalOcean API token and provide it to StackPoint so that they can provision the droplets and configure everything. Head over to DigitalOcean&rsquo;s cloud console and create a new personal access token by clicking on the Generate New Token link:</p><p><img loading=lazy src=/images/digitalocean-api-token.png alt=digitalocean-api-token></p><p>Once you generated your token copy it over to the StackPoint configuration. Next you will generate an SSH key(or use an existing one) on your machine and add it to StackPoint.<br>Now you are ready to hit create and wait since it takes a while for all droplets to be provisioned and configured. Once you are done you should see the info of the cluster and it should look somewhat like this:</p><p><img loading=lazy src=/images/stackpoint-cluster-page.png alt=stackpoint-cluster-page></p><p>Thats it!! You just created a 3 node kubernetes cluster, it really was no more than a few clicks!<br>We are almost done with the cluster setup. Now you need to configure your local <code>kubectl</code> installation to point to the recently created cluster(if have not installed <code>kubectl</code> yet follow <a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>this tutorial</a>). In the StackPoint cluster page previously showed you&rsquo;ll see a link on the left that says <code>kubeconf</code>, download that file and copy its contents to <code>~/.kube/config</code>. To check if it was properly configured run <code>kubectl cluster-info</code> and the output should look similar to this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Kubernetes master is running at https://&lt;MASTER IP&gt;:&lt;MASTER PORT&gt;
</span></span><span class=line><span class=cl>Heapster is running at https://&lt;MASTER IP&gt;:&lt;MASTER PORT&gt;/api/v1/namespaces/kube-system/services/heapster/proxy
</span></span><span class=line><span class=cl>KubeDNS is running at https://&lt;MASTER IP&gt;:&lt;MASTER PORT&gt;/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To further debug and diagnose cluster problems, use <span class=s1>&#39;kubectl cluster-info dump&#39;</span>.
</span></span></code></pre></div><h3 id=installing-gogs>Installing Gogs<a hidden class=anchor aria-hidden=true href=#installing-gogs>#</a></h3><p><a href=https://gogs.io>Gogs</a> is a lightweight git server that can deployed very easily since it does not have many dependencies and features like Gitlab CE.<br>To install Gogs on our cluster we are going to be using <a href=https://helm.sh/>Helm</a> so if you don&rsquo;t already have it installed and configured follow <a href=https://docs.helm.sh/using_helm/>this tutorial</a>. After that you need to add the <code>incubator</code> repo since that is where the gogs chart lives:</p><pre tabindex=0><code class=language-shel data-lang=shel>helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com/
</code></pre><p>Since we are going to change a lot of the default values that come with the <code>gogs</code> chart you need to clone the charts repository:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git clone https://github.com/helm/charts.git
</span></span></code></pre></div><p>Inside the <code>charts</code> repo you will have the folder <code>incubator</code> that holds the <code>gogs</code> chart. In there you&rsquo;ll find the <code>values.yml</code> file that is used when installing gogs, this file would be good for local installations but since we are installing this on a cloud provider we are going to have to change a few things.<br>This is the resulting <code>values.yml</code>, below I&rsquo;ll explain what I have changed and which properties you need to configure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>serviceType</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicaCount</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>gogs/gogs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=m>0.11.29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sshPort</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sshDomain</span><span class=p>:</span><span class=w> </span><span class=l>CHANGEME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gogs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>appName</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Some name&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runMode</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;prod&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>forcePrivate</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disableHttpGit</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repositoryUploadEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repositoryUploadAllowedTypes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repositoryUploadMaxFileSize</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repositoryUploadMaxFiles</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serviceEnableCaptcha</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serviceRegisterEmailConfirm</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serviceDisableRegistration</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serviceRequireSignInView</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serviceEnableNotifyMail</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cacheAdapter</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cacheInterval</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cacheHost</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serverDomain</span><span class=p>:</span><span class=w> </span><span class=l>CHANGEME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serverRootUrl</span><span class=p>:</span><span class=w> </span><span class=l>http://CHANGEME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serverLandingPage</span><span class=p>:</span><span class=w> </span><span class=l>home</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>databaseType</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>databaseHost</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>databaseUser</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>databasePassword</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>databaseName</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>webhookQueueLength</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>webhookDeliverTimeout</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>webhookSkipTlsVerify</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>webhookPagingNum</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logMode</span><span class=p>:</span><span class=w> </span><span class=l>console</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logLevel</span><span class=p>:</span><span class=w> </span><span class=l>Trace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>otherShowFooterBranding</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>otherShowFooterVersion</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>otherShowFooterTemplateLoadTime</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>securitySecretKey</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;changeme&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uiExplorePagingNum</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uiIssuePagingNum</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uiFeedMaxCommitNum</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;do-block-storage&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessMode</span><span class=p>:</span><span class=w> </span><span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>20Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>postgresql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>install</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgresUser</span><span class=p>:</span><span class=w> </span><span class=l>gogs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgresPassword</span><span class=p>:</span><span class=w> </span><span class=l>gogs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgresDatabase</span><span class=p>:</span><span class=w> </span><span class=l>gogs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;do-block-storage&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>5Gi</span><span class=w>
</span></span></span></code></pre></div><p>Ok, that&rsquo;s a big file and lots of configs. I&rsquo;m not going to go over each value and explain what it means(I don&rsquo;t even know), but lucky for you the <a href=https://github.com/helm/charts/blob/master/incubator/gogs/values.yaml>default values.yml</a> has a lot of comments that explain quite well each config.<br>This are the fields that were changed and the ones you need to setup:</p><ul><li><code>serviceType</code>: previously it was setup as <a href=https://kubernetes.io/docs/concepts/services-networking/service/#nodeport>NodePort</a> which is fine for local setups but since we are running in the cloud we need to specify it as a <a href=https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer>LoadBalancer</a>.</li><li><code>replicaCount</code>: it was changed from 1 to 2 so that I always have two instances running.</li><li><code>sshDomain</code>: this will be the domain used when <code>gogs</code> renders the SSH urls for clones, if you plan to setup a domain name on top of this you can use that, if not then set whatever you&rsquo;d like since this doesn&rsquo;t affect the functionality of <code>gogs</code> it&rsquo;s just that the UI will be lying to you saying to clone it as <code>git clone git@localhost:user/repo.git</code> or something like that.</li><li><code>forcePrivate</code>: set to true so that by default the UI checks the <code>private</code> checkmark when creating a new repository.</li><li><code>repositoryUploadMaxFileSize</code>: set to 50(in MB) so that the maximum file size that can be uploaded is of 50MB.</li><li><code>serverDomain</code>: the domain of gogs, same as with SSH. Use your domain name.</li><li><code>serverRotUrl</code>: basicaly <code>http</code> or <code>https</code> plus the <code>serverDomain</code>.</li><li><code>storageClass</code>: this is under the persistence section, you need to specify the <code>storageClass</code> used for persistent volumes, if you were using DigitalOcean then leave it with <code>do-block-storage</code>. Otherwise check your storage class with <code>kubectl get storageClass</code> and use that value.</li><li><code>storageClass</code>: this is the one found under the postgresql section and you should put the same value as before.</li></ul><p>Now that all the configurations are in place we can use <code>helm</code> to install gogs on our cluster. Inside the <code>charts</code> repo you recently cloned execute the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm install --name gogs -f incubator/gogs/values.yaml incubator/gogs
</span></span></code></pre></div><p>This magic command will install and configure all the pods, services, deployments and load balancers needed to run 2 replicas of gogs.<br>It will take a while before gogs is able to be used, you can check the status of the installation with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm status gogs
</span></span></code></pre></div><p>In the output of the <code>helm install</code> command you will find a few commands that will also be useful for checking the status of the installation, this one will allow you to know when the IP of the LoadBalancer is ready:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get svc --namespace <span class=o>{{</span> .Release.Namespace <span class=o>}}</span> -w <span class=o>{{</span> template <span class=s2>&#34;gogs.fullname&#34;</span> . <span class=o>}}</span>
</span></span></code></pre></div><p>After it is ready execute the following three commands to find out where exactly is <code>gogs</code> living:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>export</span> <span class=nv>NODE_PORT</span><span class=o>=</span><span class=k>$(</span>kubectl get --namespace <span class=o>{{</span> .Release.Namespace <span class=o>}}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.spec.ports[0].nodePort}&#34;</span> services <span class=o>{{</span> template <span class=s2>&#34;gogs.fullname&#34;</span> . <span class=o>}}</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>NODE_IP</span><span class=o>=</span><span class=k>$(</span>kubectl get nodes --namespace <span class=o>{{</span> .Release.Namespace <span class=o>}}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].status.addresses[0].address}&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> http://<span class=nv>$NODE_IP</span>:<span class=nv>$NODE_PORT</span>/
</span></span></code></pre></div><p>The output of the last command will show you the URL for accessing <code>gogs</code>. Head over to that URL and register a user, this user will be the admin of the application.</p><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>Congrats!!! You just created your own scalable git server running on a kubernetes cluster, it&rsquo;s amazing how the tools we have available have reduced the complexity of things such as automated deployment, scalability and availability.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.matiaspan.dev/tags/kubernetes/>kubernetes</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Deploying Gogs to a DigitalOcean Kubernetes cluster on x" href="https://x.com/intent/tweet/?text=Deploying%20Gogs%20to%20a%20DigitalOcean%20Kubernetes%20cluster&amp;url=https%3a%2f%2fblog.matiaspan.dev%2fposts%2fdeploying-gogs-to-a-custom-kubernetes-cluster%2f&amp;hashtags=kubernetes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying Gogs to a DigitalOcean Kubernetes cluster on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.matiaspan.dev%2fposts%2fdeploying-gogs-to-a-custom-kubernetes-cluster%2f&title=Deploying%20Gogs%20to%20a%20DigitalOcean%20Kubernetes%20cluster"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying Gogs to a DigitalOcean Kubernetes cluster on ycombinator" href="https://news.ycombinator.com/submitlink?t=Deploying%20Gogs%20to%20a%20DigitalOcean%20Kubernetes%20cluster&u=https%3a%2f%2fblog.matiaspan.dev%2fposts%2fdeploying-gogs-to-a-custom-kubernetes-cluster%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.matiaspan.dev/>Matias Pan's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>